# collapsed-5services.stoverride
# 说明：本覆写会在 Stash 的“第三方服务 / Availability”里添加 5 个独立项（collapsed tiles）。
# 直接安装即可，脚本内嵌，无需外部托管。
name: 增强流媒体检测
desc: 支持 Netflix/Disney+/ChatGPT/YouTube/TikTok。需要启用“切换策略组时打断连接”防止节点切换缓存。
author: xiaomingyve1
update-url: https://github.com/xiaomingyve1/stash
enable: true

tiles:
  - name: svc-netflix
    title: Netflix 解锁检测
    content: 等待检测...
    icon: play.tv.fill
    interval: 30
    collapsed: true

  - name: svc-disney
    title: Disney+ 解锁检测
    content: 等待检测...
    icon: sparkles
    interval: 30
    collapsed: true

  - name: svc-chatgpt
    title: ChatGPT 可用性检测
    content: 等待检测...
    icon: bubble.left.and.bubble.right.fill
    interval: 30
    collapsed: true

  - name: svc-youtube
    title: YouTube Premium 检测
    content: 等待检测...
    icon: play.rectangle.fill
    interval: 30
    collapsed: true

  - name: svc-spotify
    title: Spotify 解锁检测
    content: 等待检测...
    icon: music.note.list
    interval: 30
    collapsed: true

script-providers:
  svc-netflix:
    # 检查 Netflix（保持简单的原检测方式：请求示例页面，返回 200 则视为可用）
    script: |
      const REQUEST_HEADERS = { 'User-Agent': 'Mozilla/5.0', 'Accept-Language': 'en' };
      function httpGet(url, headers = {}, timeout = 6000) {
        return new Promise((resolve) => {
          $httpClient.get({url, headers, timeout}, (err, resp, data) => {
            if (err) resolve(null); else resolve({status: resp.status, data});
          });
        });
      }
      (async () => {
        try {
          const res = await httpGet('https://www.netflix.com/title/80018499', REQUEST_HEADERS);
          const ok = res && res.status === 200;
          $done({
            title: ok ? 'Netflix：已解锁' : 'Netflix：未解锁或检测失败',
            content: ok ? 'Netflix 可用 — 请在代理节点下播放确认' : '当前节点不可用或请求被拦截',
            icon: 'play.tv.fill',
            backgroundColor: ok ? '#34C759' : '#FF3B30'
          });
        } catch (e) {
          $done({ title: 'Netflix：检测异常', content: String(e), icon: 'exclamationmark.triangle' });
        }
      })();

  svc-disney:
    script: |
      const REQUEST_HEADERS = { 'User-Agent': 'Mozilla/5.0', 'Accept-Language': 'en' };
      function httpGet(url, headers = {}, timeout = 6000) {
        return new Promise((resolve) => {
          $httpClient.get({url, headers, timeout}, (err, resp, data) => {
            if (err) resolve(null); else resolve({status: resp.status, data});
          });
        });
      }
      (async () => {
        try {
          const res = await httpGet('https://www.disneyplus.com/', REQUEST_HEADERS);
          const ok = res && res.status === 200;
          $done({
            title: ok ? 'Disney+：已解锁' : 'Disney+：未解锁或检测失败',
            content: ok ? 'Disney+ 可用 — 请尝试播放内容确认' : '当前节点不可用或被限制',
            icon: 'sparkles',
            backgroundColor: ok ? '#34C759' : '#FF3B30'
          });
        } catch (e) {
          $done({ title: 'Disney+：检测异常', content: String(e), icon: 'exclamationmark.triangle' });
        }
      })();

  svc-chatgpt:
    script: |
      const REQUEST_HEADERS = { 'User-Agent': 'Mozilla/5.0', 'Accept-Language': 'en' };
      function httpGet(url, headers = {}, timeout = 6000) {
        return new Promise((resolve) => {
          $httpClient.get({url, headers, timeout}, (err, resp, data) => {
            if (err) resolve(null); else resolve({status: resp.status, data});
          });
        });
      }
      (async () => {
        try {
          // 尝试访问 chat.openai.com 的一个轻量地址（cdn-cgi/trace）来判断可达性与区域
          const res = await httpGet('https://chat.openai.com/cdn-cgi/trace', REQUEST_HEADERS);
          let ok = false;
          let region = '';
          if (res && res.status === 200 && res.data) {
            ok = true;
            const m = String(res.data).match(/loc=([A-Z]{2})/);
            if (m) region = m[1];
          }
          $done({
            title: ok ? `ChatGPT：可用 ${region ? '(' + region + ')' : ''}` : 'ChatGPT：不可用或检测失败',
            content: ok ? `ChatGPT 可访问 — 区域: ${region || '未知'}` : '当前节点无法访问 ChatGPT',
            icon: 'bubble.left.and.bubble.right.fill',
            backgroundColor: ok ? '#34C759' : '#FF3B30'
          });
        } catch (e) {
          $done({ title: 'ChatGPT：检测异常', content: String(e), icon: 'exclamationmark.triangle' });
        }
      })();

  svc-youtube:
    script: |
      const REQUEST_HEADERS = { 'User-Agent': 'Mozilla/5.0', 'Accept-Language': 'en' };
      function httpGet(url, headers = {}, timeout = 6000) {
        return new Promise((resolve) => {
          $httpClient.get({url, headers, timeout}, (err, resp, data) => {
            if (err) resolve(null); else resolve({status: resp.status, data});
          });
        });
      }
      (async () => {
        try {
          const res = await httpGet('https://www.youtube.com/premium', REQUEST_HEADERS);
          const ok = res && res.status === 200;
          $done({
            title: ok ? 'YouTube Premium：已解锁' : 'YouTube Premium：未解锁或检测失败',
            content: ok ? 'YouTube Premium 页面可访问' : '当前节点无法访问 YouTube Premium',
            icon: 'play.rectangle.fill',
            backgroundColor: ok ? '#34C759' : '#FF3B30'
          });
        } catch (e) {
          $done({ title: 'YouTube：检测异常', content: String(e), icon: 'exclamationmark.triangle' });
        }
      })();

  svc-spotify:
    script: |
      const REQUEST_HEADERS = { 'User-Agent': 'Mozilla/5.0', 'Accept-Language': 'en' };
      function httpGet(url, headers = {}, timeout = 6000) {
        return new Promise((resolve) => {
          $httpClient.get({url, headers, timeout}, (err, resp, data) => {
            if (err) resolve(null); else resolve({status: resp.status, data});
          });
        });
      }
      (async () => {
        try {
          const res = await httpGet('https://open.spotify.com/', REQUEST_HEADERS);
          const ok = res && res.status === 200;
          $done({
            title: ok ? 'Spotify：已解锁' : 'Spotify：未解锁或检测失败',
            content: ok ? 'Spotify 首页可访问' : '当前节点无法访问 Spotify',
            icon: 'music.note.list',
            backgroundColor: ok ? '#34C759' : '#FF3B30'
          });
        } catch (e) {
          $done({ title: 'Spotify：检测异常', content: String(e), icon: 'exclamationmark.triangle' });
        }
      })();
