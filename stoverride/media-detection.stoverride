name: 流媒体检测(服务面板版)
desc: 独立显示 Netflix/Disney+/YouTube/TikTok/ChatGPT。已针对服务面板优化，强制30秒刷新。
author: xiaomingyve1
enable: true

# ================= 1. 面板入口 =================
# 这里的名称必须和下方 script-providers 里的名称完全一致
panel-items:
  - script: check-netflix
  - script: check-disney
  - script: check-youtube
  - script: check-tiktok
  - script: check-chatgpt

# ================= 2. 脚本逻辑 =================
script-providers:
  # --- Netflix ---
  check-netflix:
    argument: "Netflix"
    interval: 30
    schedule: [manual, network-change]
    no-cache: true
    content: &script_code |
      (async () => {
        const target = typeof $argument !== 'undefined' ? $argument : 'Netflix';
        
        // 1. 配置参数
        const CFG = {
          'Netflix': { url: 'https://www.netflix.com/title/81280792', icon: 'play.tv.fill', color: '#E50914' },
          'Disney':  { url: 'https://www.disneyplus.com/', icon: 'play.circle.fill', color: '#113CCF' },
          'YouTube': { url: 'https://www.youtube.com/premium', icon: 'play.rectangle.fill', color: '#FF0000' },
          'TikTok':  { url: 'https://www.tiktok.com/', icon: 'music.note', color: '#000000' },
          'ChatGPT': { url: 'https://chat.openai.com/cdn-cgi/trace', icon: 'message.fill', color: '#10A37F' }
        };
        const cur = CFG[target];
        
        // 2. 超时保护 (5秒强制返回，防止面板空白)
        const timeout = new Promise(resolve => setTimeout(() => resolve({code:'Timeout'}), 5000));
        
        // 3. 检测逻辑
        const check = new Promise(resolve => {
          const opts = { url: cur.url, headers: {'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1'}, timeout: 4000 };
          
          // 特殊处理 Disney POST
          if(target === 'Disney') {
            opts.url = 'https://disney.api.edge.bamgrid.com/graph/v1/device/graphql';
            opts.headers['Authorization'] = 'ZGlzbmV5JmJyb3dzZXImMS4wLjA.Cu56AgSfBTDag5NiRA81oLHkDZfu5L3CKadnefEAY84';
            opts.headers['Content-Type'] = 'application/json';
            opts.body = JSON.stringify({query: 'mutation registerDevice($input: RegisterDeviceInput!) { registerDevice(registerDevice: $input) { grant { grantType assertion } } }', variables: {input: {applicationRuntime: 'chrome', attributes: {browserName: 'chrome', browserVersion: '94.0.4606', operatingSystem: 'macintosh'}, deviceFamily: 'browser', deviceProfile: 'macosx'}}});
            $httpClient.post(opts, (e,r,d) => resolve({e,r,d}));
          } else {
            $httpClient.get(opts, (e,r,d) => resolve({e,r,d}));
          }
        });

        // 4. 执行并处理结果
        try {
          const res = await Promise.race([check, timeout]);
          let msg = '检测失败';
          let color = '#999999';

          if (res.code === 'Timeout') {
            msg = '请求超时';
          } else if (res.e || !res.r) {
            msg = '网络错误';
          } else {
            // --- 结果解析 ---
            const { r, d } = res;
            // Netflix
            if (target === 'Netflix') {
               if(r.status===200) { const u=r.headers['x-originating-url']; msg='已解锁: '+(u?u.split('/')[3].split('-')[0].toUpperCase():'US'); color=cur.color; }
               else if(r.status===404) { msg='仅自制剧'; color='#FF9500'; }
               else { msg='未解锁'; }
            }
            // Disney
            else if (target === 'Disney') {
               if(r.status===200) { try{const j=JSON.parse(d); if(j.errors)throw 1; const loc=j.extensions.sdk.session.location.countryCode; msg='已解锁: '+loc; color=cur.color;}catch{msg='未解锁';} }
               else { msg='未解锁'; }
            }
            // YouTube
            else if (target === 'YouTube') {
               if(d.includes('Premium is not available')) { msg='未解锁'; }
               else { const m=/"countryCode":"(.*?)"/.exec(d); msg='Premium: '+(m?m[1]:'US'); color=cur.color; }
            }
            // TikTok
            else if (target === 'TikTok') {
               const m=/region.*?:.*?"([A-Z]{2})"/ .exec(d);
               if(m && m[1]!=='CN') { msg='已解锁: '+m[1]; color=cur.color; }
               else { msg='受限/失败'; }
            }
            // ChatGPT
            else if (target === 'ChatGPT') {
               const m=/loc=([A-Z]{2})/.exec(d);
               if(m) { msg='已解锁: '+m[1]; color=cur.color; }
               else { msg='未解锁'; }
            }
          }

          $done({ title: target, content: msg, icon: cur.icon, 'icon-color': color });
        } catch(e) {
          $done({ title: target, content: '脚本错误', icon: 'exclamationmark.triangle' });
        }
      })();

  # --- 其他服务 (复用代码) ---
  check-disney:
    argument: "Disney"
    interval: 30
    schedule: [manual, network-change]
    no-cache: true
    content: *script_code

  check-youtube:
    argument: "YouTube"
    interval: 30
    schedule: [manual, network-change]
    no-cache: true
    content: *script_code

  check-tiktok:
    argument: "TikTok"
    interval: 30
    schedule: [manual, network-change]
    no-cache: true
    content: *script_code

  check-chatgpt:
    argument: "ChatGPT"
    interval: 30
    schedule: [manual, network-change]
    no-cache: true
    content: *script_code
